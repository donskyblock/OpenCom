cat > voice-regression-fix.patch <<'PATCH'
diff --git a/backend/packages/server-node/src/gateway.ts b/backend/packages/server-node/src/gateway.ts
--- a/backend/packages/server-node/src/gateway.ts
+++ b/backend/packages/server-node/src/gateway.ts
@@ -1,33 +1,34 @@
 import { randomUUID } from "node:crypto";
 import { WebSocketServer } from "ws";
 import type { FastifyInstance } from "fastify";
 import { GatewayEnvelope, NodeIdentify } from "@ods/shared/events.js";
 import { verifyMembershipToken } from "./auth/verifyMembership.js";
 import { q } from "./db.js";
 import { env } from "./env.js";
 import { requireGuildMember } from "./auth/requireGuildMember.js";
 import { resolveChannelPermissions } from "./permissions/resolve.js";
 import { Perm, has } from "./permissions/bits.js";
 import {
   getRouterRtpCapabilities,
   ensurePeer,
   createWebRtcTransport,
   connectTransport,
   produce,
   consume,
   listProducers,
   closePeer,
+  getMediasoupDiagnostics,
 } from "./voice/mediasoup.js";
 import { createLogger, sanitizeErrorMessage } from "./logger.js";

 const logger = createLogger("gateway:voice");

diff --git a/backend/packages/server-node/src/voice/mediasoup.ts b/backend/packages/server-node/src/voice/mediasoup.ts
--- a/backend/packages/server-node/src/voice/mediasoup.ts
+++ b/backend/packages/server-node/src/voice/mediasoup.ts
@@ -1,6 +1,7 @@
 import mediasoup from "mediasoup";
 import { env } from "../env.js";

 type RoomKey = string; // `${guildId}:${channelId}`

 type Room = {
   router: mediasoup.types.Router;
   peers: Map<string, Peer>;
 };
@@ -21,6 +22,36 @@
 const rooms = new Map<RoomKey, Room>();

 let worker: mediasoup.types.Worker | null = null;

+export function getMediasoupDiagnostics() {
+  let peerCount = 0;
+  let transportCount = 0;
+  let producerCount = 0;
+  let consumerCount = 0;
+
+  for (const room of rooms.values()) {
+    for (const peer of room.peers.values()) {
+      peerCount += 1;
+      transportCount += peer.transports.size;
+      producerCount += peer.producers.size;
+      consumerCount += peer.consumers.size;
+    }
+  }
+
+  return {
+    worker: !!worker,
+    rooms: rooms.size,
+    peers: peerCount,
+    transports: transportCount,
+    producers: producerCount,
+    consumers: consumerCount
+  };
+}
+
 export async function initMediasoup() {
   worker = await mediasoup.createWorker({
     rtcMinPort: env.MEDIASOUP_RTC_MIN_PORT,
     rtcMaxPort: env.MEDIASOUP_RTC_MAX_PORT
   });
@@ -72,7 +103,12 @@
   return room.peers.get(userId)!;
 }

-export async function createWebRtcTransport(guildId: string, channelId: string, userId: string) {
+export async function createWebRtcTransport(
+  guildId: string,
+  channelId: string,
+  userId: string,
+  direction?: "send" | "recv"
+) {
   const room = await getOrCreateRoom(guildId, channelId);
   const peer = await ensurePeer(guildId, channelId, userId);

   const transport = await room.router.createWebRtcTransport({
     listenIps: [{ ip: env.MEDIASOUP_LISTEN_IP, announcedIp: env.MEDIASOUP_ANNOUNCED_IP }],
     enableUdp: true,
     enableTcp: true,
     preferUdp: true
   });

+  try {
+    (transport as any).appData = { ...(transport as any).appData, guildId, channelId, userId, direction };
+  } catch {}
+
   peer.transports.set(transport.id, transport);

   return {
     id: transport.id,
     iceParameters: transport.iceParameters,
     iceCandidates: transport.iceCandidates,
     dtlsParameters: transport.dtlsParameters
   };
 }
PATCH
